{% extends 'stock/base.html' %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - WB Stock Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-chart-bar me-2 text-success"></i>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h1>
    <div>
        <a href="?refresh=1" class="btn btn-outline-warning">
            <i class="fas fa-sync-alt me-2"></i>–û–±–Ω–æ–≤–∏—Ç—å
        </a>
    </div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç–µ –∏ –∫—ç—à–µ -->
{% if analytics_data %}
<div class="alert alert-info border-0 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-calendar-day me-2"></i>
            <strong>–î–∞—Ç–∞:</strong> {{ analytics_data.date }}
            <small class="text-muted ms-2">(–¥–∞–Ω–Ω—ã–µ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 20 –º–∏–Ω—É—Ç)</small>
        </div>
        <div class="text-muted">
            <i class="fas fa-database me-1"></i>
            –ö—ç—à: {% if not request.GET.refresh %}–∞–∫—Ç–∏–≤–µ–Ω{% else %}–æ–±–Ω–æ–≤–ª–µ–Ω{% endif %}
        </div>
    </div>
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger border-0 mb-4">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
    {% if "—Ç–æ–∫–µ–Ω" in error %}
    <a href="{% url 'profile' %}" class="alert-link">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
    {% endif %}
</div>
{% endif %}

{% if analytics_data and analytics_data.success %}
<!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->


<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-0 h-100">
            <div class="card-body text-center">
                <div class="icon-wrapper mx-auto mb-3">
                    <i class="fas fa-shopping-cart text-primary"></i>
                </div>
                <h3 class="text-primary">{{ analytics_data.orders.count }}</h3>
                <h6 class="text-muted mb-1">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</h6>
                <p class="mb-0 text-light">{{ analytics_data.orders.sum|floatformat:0 }} —Ä—É–±.</p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-0 h-100">
            <div class="card-body text-center">
                <div class="icon-wrapper mx-auto mb-3">
                    <i class="fas fa-check-circle text-success"></i>
                </div>
                <h3 class="text-success">{{ analytics_data.sales.count }}</h3>
                <h6 class="text-muted mb-1">–†–µ–∞–ª—å–Ω—ã—Ö –≤—ã–∫—É–ø–æ–≤</h6>
                <p class="mb-0 text-light">{{ analytics_data.sales.sum|floatformat:0 }} —Ä—É–±.</p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-0 h-100">
            <div class="card-body text-center">
                <div class="icon-wrapper mx-auto mb-3">
                    <i class="fas fa-times-circle text-danger"></i>
                </div>
                <h3 class="text-danger">{{ analytics_data.cancellations.count }}</h3>
                <h6 class="text-muted mb-1">–û—Ç–∫–∞–∑–æ–≤</h6>
                <p class="mb-0 text-light">{{ analytics_data.cancellations.sum|floatformat:0 }} —Ä—É–±.</p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-0 h-100">
            <div class="card-body text-center">
                <div class="icon-wrapper mx-auto mb-3">
                    <i class="fas fa-exchange-alt text-warning"></i>
                </div>
                <h3 class="text-warning">{{ analytics_data.returns.count }}</h3>
                <h6 class="text-muted mb-1">–í–æ–∑–≤—Ä–∞—Ç–æ–≤</h6>
                <p class="mb-0 text-light">{{ analytics_data.returns.sum|floatformat:0 }} —Ä—É–±.</p>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card border-0 h-100">
            <div class="card-body text-center">
                <h6 class="card-title mb-3">üìà –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –≤—ã–∫—É–ø—ã</h6>
                <div class="display-4 text-success mb-2">
                    {{ analytics_data.conversion_rate|floatformat:1 }}%
                </div>
                <small class="text-muted">–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–∫–∞–∑–æ–≤, –ø—Ä–µ–≤—Ä–∞—Ç–∏–≤—à–∏—Ö—Å—è –≤ –≤—ã–∫—É–ø—ã</small>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card border-0 h-100">
            <div class="card-body text-center">
                <h6 class="card-title mb-3">üìâ –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤</h6>
                <div class="display-4 text-danger mb-2">
                    {{ analytics_data.cancellation_rate|floatformat:1 }}%
                </div>
                <small class="text-muted">–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–∫–∞–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω—ã</small>
            </div>
        </div>
    </div>
</div>

<!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è -->
<div class="row">
    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 h-100">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="fas fa-shopping-cart me-2"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã
                    <span class="badge bg-primary ms-2">{{ analytics_data.orders.data|length }}</span>
                </h6>
                {% if analytics_data.orders.data %}
                <div class="table-responsive">
                    <table class="table table-sm table-borderless">
                        <thead>
                            <tr>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th class="text-end">–¶–µ–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in analytics_data.orders.data %}
                            <tr>
                                <td>
                                    <div>
                                        <small class="d-block text-truncate" style="max-width: 150px;" 
                                               title="{{ order.name }}">
                                            {{ order.name }}
                                        </small>
                                        <small class="text-muted">–ê—Ä—Ç: {{ order.article }}</small>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-primary">{{ order.price|floatformat:0 }} —Ä—É–±.</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–∞—Ö</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∫—É–ø—ã -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 h-100">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="fas fa-check-circle me-2"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∫—É–ø—ã
                    <span class="badge bg-success ms-2">{{ analytics_data.sales.data|length }}</span>
                </h6>
                {% if analytics_data.sales.data %}
                <div class="table-responsive">
                    <table class="table table-sm table-borderless">
                        <thead>
                            <tr>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th class="text-end">–¶–µ–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in analytics_data.sales.data %}
                            <tr>
                                <td>
                                    <div>
                                        <small class="d-block text-truncate" style="max-width: 150px;" 
                                               title="{{ sale.name }}">
                                            {{ sale.name }}
                                        </small>
                                        <small class="text-muted">–ê—Ä—Ç: {{ sale.article }}</small>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-success">{{ sale.price|floatformat:0 }} —Ä—É–±.</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã–∫—É–ø–∞—Ö</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –û—Ç–∫–∞–∑—ã (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å) -->
{% if analytics_data.cancellations.count > 0 %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card border-0">
            <div class="card-body">
                <h6 class="card-title mb-3 text-danger">
                    <i class="fas fa-times-circle me-2"></i>–û—Ç–∫–∞–∑—ã
                    <span class="badge bg-danger ms-2">{{ analytics_data.cancellations.data|length }}</span>
                </h6>
                <div class="table-responsive">
                    <table class="table table-sm table-borderless">
                        <thead>
                            <tr>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th class="text-end">–¶–µ–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cancellation in analytics_data.cancellations.data %}
                            <tr>
                                <td>
                                    <div>
                                        <small class="d-block text-truncate" style="max-width: 150px;" 
                                               title="{{ cancellation.name }}">
                                            {{ cancellation.name }}
                                        </small>
                                        <small class="text-muted">–ê—Ä—Ç: {{ cancellation.article }}</small>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-danger">{{ cancellation.price|floatformat:0 }} —Ä—É–±.</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% elif analytics_data and not analytics_data.success %}
<div class="alert alert-warning border-0">
    <i class="fas fa-exclamation-triangle me-2"></i>
    –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API —Ç–æ–∫–µ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ.
</div>
{% endif %}

{% if not analytics_data and not error %}
<div class="card border-0 text-center py-5">
    <div class="card-body">
        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
        <h4>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞</h4>
        <p class="text-muted mb-4">–î–æ–±–∞–≤—å—Ç–µ API —Ç–æ–∫–µ–Ω Wildberries –≤ –ø—Ä–æ—Ñ–∏–ª–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ</p>
        <a href="{% url 'profile' %}" class="btn btn-primary">
            <i class="fas fa-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </a>
    </div>
</div>
{% endif %}
{% endblock %}