{% extends 'stock/base.html' %}

{% block title %}{{ page_title }} - WB Stock Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üéØ {{ page_title }}</h1>
    <div>
        <a href="{% url 'campaign_edit' campaign.id %}" class="btn btn-outline-primary me-2">
            <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </a>
        <a href="{% url 'campaign_list' %}" class="btn btn-primary">
            <i class="fas fa-arrow-left me-2"></i>–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏
        </a>
    </div>
</div>

<div class="row">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="col-lg-4 mb-4">
        <div class="card border-0 h-100">
            <div class="card-header bg-dark border-0">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–º–ø–∞–Ω–∏–∏</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>–¢–∏–ø:</strong>
                    <span class="badge bg-primary ms-2">{{ campaign.get_campaign_type_display }}</span>
                </div>
                <div class="mb-3">
                    <strong>–°—Ç–∞—Ç—É—Å:</strong>
                    <span class="badge {% if campaign.status == 'active' %}bg-success{% elif campaign.status == 'paused' %}bg-warning{% else %}bg-danger{% endif %} ms-2">
                        {{ campaign.get_status_display }}
                    </span>
                </div>
                <div class="mb-3">
                    <strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong>
                    <span class="ms-2">{{ campaign.start_date }}</span>
                </div>
                {% if campaign.end_date %}
                <div class="mb-3">
                    <strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong>
                    <span class="ms-2">{{ campaign.end_date }}</span>
                </div>
                {% endif %}
                <div class="mb-3">
                    <strong>–î–Ω–µ–π —Ä–∞–±–æ—Ç—ã:</strong>
                    <span class="ms-2">{{ campaign.days_running }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="col-lg-4 mb-4">
        <div class="card border-0 h-100">
            <div class="card-header bg-dark border-0">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>–í—Å–µ–≥–æ –∑–∞—Ç—Ä–∞—Ç:</strong>
                    <span class="fw-bold text-warning ms-2">{{ campaign.total_spent|floatformat:2 }} ‚ÇΩ</span>
                </div>
                <div class="mb-3">
                    <strong>–ü–æ–∫–∞–∑—ã:</strong>
                    <span class="fw-bold text-info ms-2">{{ campaign.total_views }}</span>
                </div>
                <div class="mb-3">
                    <strong>–ö–ª–∏–∫–∏:</strong>
                    <span class="fw-bold text-primary ms-2">{{ campaign.total_clicks }}</span>
                </div>
                <div class="mb-3">
                    <strong>–î–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É:</strong>
                    <span class="fw-bold text-warning ms-2">{{ campaign.total_cart_adds }}</span>
                </div>
                <div class="mb-3">
                    <strong>–ó–∞–∫–∞–∑—ã:</strong>
                    <span class="fw-bold text-success ms-2">{{ campaign.total_orders }}</span>
                </div>
                <div class="mb-3">
                    <strong>CTR:</strong>
                    <span class="fw-bold ms-2">{{ campaign.ctr|floatformat:2 }}%</span>
                </div>
                <div class="mb-3">
                    <strong>CPO:</strong>
                    <span class="fw-bold ms-2">{{ campaign.cpo|floatformat:2 }} ‚ÇΩ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–æ–≤–∞—Ä—ã –∫–∞–º–ø–∞–Ω–∏–∏ -->
    <div class="col-lg-4 mb-4">
        <div class="card border-0 h-100">
            <div class="card-header bg-dark border-0">
                <h5 class="mb-0"><i class="fas fa-cubes me-2"></i>–¢–æ–≤–∞—Ä—ã –≤ –∫–∞–º–ø–∞–Ω–∏–∏</h5>
            </div>
            <div class="card-body">
                {% if campaign.products.all %}
                    {% for product in campaign.products.all %}
                    <div class="d-flex align-items-center mb-2 p-2 border-bottom border-secondary">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                             class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                        {% else %}
                        <div class="bg-secondary rounded me-2 d-flex align-items-center justify-content-center" 
                             style="width: 40px; height: 40px;">
                            <i class="fas fa-cube text-light"></i>
                        </div>
                        {% endif %}
                        <div>
                            <div class="fw-semibold">{{ product.name }}</div>
                            <small class="text-muted">–ê—Ä—Ç: {{ product.article }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-cube fa-2x mb-2"></i>
                        <p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞–º–ø–∞–Ω–∏–∏</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0">
            <div class="card-header bg-dark border-0">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>–î–∏–Ω–∞–º–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏</h5>
            </div>
            <div class="card-body">
                {% if daily_stats %}
                <div class="chart-container">
                    <canvas id="campaignChart"></canvas>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                    <small>–î–æ–±–∞–≤—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–º–ø–∞–Ω–∏–∏ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card border-0">
            <div class="card-header bg-dark border-0">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –¥–µ–Ω—å</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–î–∞—Ç–∞</label>
                                {{ stats_form.date }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–ó–∞—Ç—Ä–∞—Ç—ã (—Ä—É–±)</label>
                                {{ stats_form.spent }}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–ü–æ–∫–∞–∑—ã</label>
                                {{ stats_form.views }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–ö–ª–∏–∫–∏</label>
                                {{ stats_form.clicks }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–î–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É</label>
                                {{ stats_form.cart_adds }}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–ó–∞–∫–∞–∑—ã</label>
                                {{ stats_form.orders }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="col-lg-6">
        <div class="card border-0">
            <div class="card-header bg-dark border-0">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h5>
            </div>
            <div class="card-body">
                {% if daily_stats %}
                <div class="table-responsive">
    <table class="table table-sm">
        <thead>
            <tr>
                <th style="color: var(--text-light) !important; font-weight: 700;">–î–∞—Ç–∞</th>
                <th style="color: var(--text-light) !important; font-weight: 700;">–ü–æ–∫–∞–∑—ã</th>
                <th style="color: var(--text-light) !important; font-weight: 700;">–ö–ª–∏–∫–∏</th>
                <th style="color: var(--text-light) !important; font-weight: 700;">–ö–æ—Ä–∑–∏–Ω—ã</th>
                <th style="color: var(--text-light) !important; font-weight: 700;">–ó–∞–∫–∞–∑—ã</th>
                <th style="color: var(--text-light) !important; font-weight: 700;">–ó–∞—Ç—Ä–∞—Ç—ã</th>
                <th style="color: var(--text-light) !important; font-weight: 700;">CTR</th>
                <th style="color: var(--text-light) !important; font-weight: 700;">CPC</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in daily_stats|slice:":10" %}
            <tr>
                <td>{{ stat.date }}</td>
                <td>{{ stat.views }}</td>
                <td>{{ stat.clicks }}</td>
                <td>{{ stat.cart_adds }}</td>
                <td class="fw-bold text-success">{{ stat.orders }}</td>
                <td class="fw-bold text-warning">{{ stat.spent }} ‚ÇΩ</td>
                <td>{{ stat.ctr|floatformat:2 }}%</td>
                <td>{{ stat.cpc|floatformat:2 }} ‚ÇΩ</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="fas fa-chart-bar fa-2x mb-2"></i>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if daily_stats %}
<script>
// –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
    const campaignCtx = document.getElementById('campaignChart').getContext('2d');
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (–±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –∑–∞–ø–∏—Å–µ–π)
    const stats = {{ daily_stats|slice:":30"|length }};
    const chartDates = [
        {% for stat in daily_stats|slice:":30" %}
        "{{ stat.date|date:'d.m' }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ].reverse(); // –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —á—Ç–æ–±—ã –¥–∞—Ç—ã —à–ª–∏ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º

    const chartSpends = [
        {% for stat in daily_stats|slice:":30" %}
        {{ stat.spent }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ].reverse();

    const chartOrders = [
        {% for stat in daily_stats|slice:":30" %}
        {{ stat.orders }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ].reverse();

    const chartClicks = [
        {% for stat in daily_stats|slice:":30" %}
        {{ stat.clicks }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ].reverse();

    const chartViews = [
        {% for stat in daily_stats|slice:":30" %}
        {{ stat.views }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ].reverse();

    console.log('Dates:', chartDates);
    console.log('Spends:', chartSpends);
    console.log('Orders:', chartOrders);
    
    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    new Chart(campaignCtx, {
        type: 'line',
        data: {
            labels: chartDates,
            datasets: [
                {
                    label: '–ó–∞—Ç—Ä–∞—Ç—ã (—Ä—É–±)',
                    data: chartSpends,
                    borderColor: '#ff6b35',
                    backgroundColor: 'rgba(255, 107, 53, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: '–ó–∞–∫–∞–∑—ã',
                    data: chartOrders,
                    borderColor: '#51cf66',
                    backgroundColor: 'rgba(81, 207, 102, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: '–ö–ª–∏–∫–∏',
                    data: chartClicks,
                    borderColor: '#339af0',
                    backgroundColor: 'rgba(51, 154, 240, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '–ó–∞—Ç—Ä–∞—Ç—ã (—Ä—É–±)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#adb5bd'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '–ö–ª–∏–∫–∏/–ó–∞–∫–∞–∑—ã'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        color: '#adb5bd'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#adb5bd'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#f8f9fa',
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
});
</script>
{% endif %}

<style>
.chart-container {
    height: 400px;
    position: relative;
}

/* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ canvas –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–ª–æ—â–∞–¥—å */
#campaignChart {
    width: 100% !important;
    height: 100% !important;
}
</style>
{% endblock %}